<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presigned URL Upload Example</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .upload-area { border: 2px dashed #ccc; padding: 20px; text-align: center; margin: 20px 0; }
        .progress { width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; }
        .progress-bar { height: 100%; background: #4CAF50; width: 0%; transition: width 0.3s; }
        .status { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <h1>Presigned URL Upload Example</h1>
    
    <div class="upload-area">
        <input type="file" id="fileInput" accept=".pdf" />
        <p>Select a PDF file to upload (up to 50MB)</p>
    </div>
    
    <button id="uploadBtn" disabled>Upload File</button>
    
    <div class="progress" style="display: none;">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    
    <div id="status"></div>

    <script>
        const API_BASE = 'https://your-api-gateway-url.com/prod/api'; // Replace with your API URL
        const AUTH_TOKEN = 'your-jwt-token'; // Replace with actual JWT token

        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const progressBar = document.getElementById('progressBar');
        const status = document.getElementById('status');

        let selectedFile = null;

        fileInput.addEventListener('change', (e) => {
            selectedFile = e.target.files[0];
            uploadBtn.disabled = !selectedFile;
            
            if (selectedFile) {
                showStatus(`Selected: ${selectedFile.name} (${(selectedFile.size / 1024 / 1024).toFixed(2)} MB)`, 'info');
            }
        });

        uploadBtn.addEventListener('click', uploadFile);

        async function uploadFile() {
            if (!selectedFile) return;

            try {
                uploadBtn.disabled = true;
                showStatus('Getting upload URL...', 'info');

                // Step 1: Get presigned URL
                const presignedResponse = await fetch(`${API_BASE}/upload/presigned-url`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        fileName: selectedFile.name,
                        fileType: selectedFile.type,
                        fileSize: selectedFile.size
                    })
                });

                if (!presignedResponse.ok) {
                    const error = await presignedResponse.json();
                    throw new Error(error.message || 'Failed to get upload URL');
                }

                const { uploadUrl, key } = await presignedResponse.json();

                // Step 2: Upload directly to S3
                showStatus('Uploading to S3...', 'info');
                document.querySelector('.progress').style.display = 'block';

                const uploadResponse = await fetch(uploadUrl, {
                    method: 'PUT',
                    body: selectedFile,
                    headers: {
                        'Content-Type': selectedFile.type
                    },
                    // Track upload progress
                    onUploadProgress: (progressEvent) => {
                        const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                        progressBar.style.width = percentCompleted + '%';
                    }
                });

                if (!uploadResponse.ok) {
                    throw new Error('Failed to upload file to S3');
                }

                progressBar.style.width = '100%';
                showStatus('Confirming upload...', 'info');

                // Step 3: Confirm upload with your API
                const confirmResponse = await fetch(`${API_BASE}/upload/confirm`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        key: key,
                        fileName: selectedFile.name,
                        fileType: selectedFile.type,
                        fileSize: selectedFile.size
                    })
                });

                if (!confirmResponse.ok) {
                    const error = await confirmResponse.json();
                    throw new Error(error.message || 'Failed to confirm upload');
                }

                const result = await confirmResponse.json();
                showStatus(`Upload successful! File ID: ${result.data._id}`, 'success');

                // Reset form
                fileInput.value = '';
                selectedFile = null;
                document.querySelector('.progress').style.display = 'none';
                progressBar.style.width = '0%';

            } catch (error) {
                showStatus(`Upload failed: ${error.message}`, 'error');
                document.querySelector('.progress').style.display = 'none';
                progressBar.style.width = '0%';
            } finally {
                uploadBtn.disabled = !selectedFile;
            }
        }

        function showStatus(message, type) {
            status.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // Alternative implementation using XMLHttpRequest for better progress tracking
        async function uploadFileWithProgress() {
            if (!selectedFile) return;

            try {
                uploadBtn.disabled = true;
                showStatus('Getting upload URL...', 'info');

                // Step 1: Get presigned URL
                const presignedResponse = await fetch(`${API_BASE}/upload/presigned-url`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        fileName: selectedFile.name,
                        fileType: selectedFile.type,
                        fileSize: selectedFile.size
                    })
                });

                if (!presignedResponse.ok) {
                    const error = await presignedResponse.json();
                    throw new Error(error.message || 'Failed to get upload URL');
                }

                const { uploadUrl, key } = await presignedResponse.json();

                // Step 2: Upload with progress tracking
                showStatus('Uploading to S3...', 'info');
                document.querySelector('.progress').style.display = 'block';

                await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();

                    xhr.upload.addEventListener('progress', (e) => {
                        if (e.lengthComputable) {
                            const percentComplete = (e.loaded / e.total) * 100;
                            progressBar.style.width = percentComplete + '%';
                        }
                    });

                    xhr.addEventListener('load', () => {
                        if (xhr.status === 200) {
                            resolve(xhr.response);
                        } else {
                            reject(new Error('Upload failed'));
                        }
                    });

                    xhr.addEventListener('error', () => {
                        reject(new Error('Upload failed'));
                    });

                    xhr.open('PUT', uploadUrl);
                    xhr.setRequestHeader('Content-Type', selectedFile.type);
                    xhr.send(selectedFile);
                });

                showStatus('Confirming upload...', 'info');

                // Step 3: Confirm upload
                const confirmResponse = await fetch(`${API_BASE}/upload/confirm`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        key: key,
                        fileName: selectedFile.name,
                        fileType: selectedFile.type,
                        fileSize: selectedFile.size
                    })
                });

                if (!confirmResponse.ok) {
                    const error = await confirmResponse.json();
                    throw new Error(error.message || 'Failed to confirm upload');
                }

                const result = await confirmResponse.json();
                showStatus(`Upload successful! File ID: ${result.data._id}`, 'success');

                // Reset form
                fileInput.value = '';
                selectedFile = null;
                document.querySelector('.progress').style.display = 'none';
                progressBar.style.width = '0%';

            } catch (error) {
                showStatus(`Upload failed: ${error.message}`, 'error');
                document.querySelector('.progress').style.display = 'none';
                progressBar.style.width = '0%';
            } finally {
                uploadBtn.disabled = !selectedFile;
            }
        }
    </script>
</body>
</html>
